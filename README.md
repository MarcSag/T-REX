# T-REX: Template-based Radiomics Extraction Pipeline

**T-REX** (The Radiomics Extractor) is a modular Python pipeline designed to automate radiomics feature extraction from medical imaging. This pipeline includes the following steps:
- Conversion of DICOM images to NIfTI format.
- Extraction of metadata from converted files.
- Brain mask generation using **HD-BET**.
- Registration of templates and atlases on brain or whole-head images.
- Radiomics feature extraction based on custom ROIs, brain masks, or atlas regions.

---

## Key Features

- Full automation of pipelines combining DICOM to NIfTI conversion, registration, and radiomics extraction.
- Support for multiple input types: DICOM and NIfTI.
- Extraction of metadata from input images, saved as `.json` files.
- Brain-specific segmentation using **HD-BET** for focused analyses.
- Compatibility with anatomical atlases to define regions (e.g., occipital lobe, ventricles) and extract radiomics features from them.
- Results are saved as comprehensive CSV files containing all radiomics features.

---

## Requirements

### Software
- **Python â‰¥ 3.7**
- External tools:
  - `dcm2niix`: DICOM to NIfTI conversion, with metadata extraction.
  - `hd-bet`: Brain mask generation.
  - [FSL FLIRT](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FLIRT): Registration tools.
  - [ANTs Registration](http://stnava.github.io/ANTs/): Template/atlas registration.

### Python Libraries
Ensure the following libraries are installed (or install them via `requirements.txt`):
- pandas
- numpy
- nibabel
- SimpleITK
- pyradiomics
- nipype
- antspyx

---

## Installation

1. Clone this GitHub repository:
   ```bash
   git clone https://github.com/your-username/T-REX.git
   cd T-REX
   ```

2. Install Python dependencies:
   ```bash
   pip install -r requirements.txt
   ```

3. Verify that `dcm2niix`, `hd-bet`, and other required external software (ANTs, FSL) are installed and available in your system PATH.

---

## Usage

### Run the pipeline on a single image:

```bash
python trex.py --input <image_path> --output <output_directory> [options]
```

#### Required arguments:
- `<image_path>`: Path to a DICOM or NIfTI image.
- `<output_directory>`: Directory where the results will be saved.

#### Optional arguments (processing steps):
- `--metadata`: Enables metadata extraction from images. Generates a `.json` file.
- `--bet`: Performs brain segmentation using HD-BET.
- `--register`: Registers a template/atlas to the image. Requires `--bet`.
- `--radiomics`: Extracts radiomics features (for atlas regions, ROIs, etc.).
- `--roi`: Specify one or more custom NIfTI masks for ROIs.

---

### Default Behavior:
If no specific arguments other than `--input` and `--output` are provided, the pipeline will execute **all available steps**.

#### Example:
```bash
python trex.py --input image.dcm --output results/
```

This will perform:
1. DICOM to NIfTI conversion.
2. Metadata extraction.
3. Brain mask generation.
4. Template/Atlas registration.
5. Radiomics feature extraction.

---

## Output Structure

### Organization of Output Files

Results are stored in the specified output directory (`--output`), organized based on the steps performed:

| Step                    | Generated Files                                                             |
|-------------------------|-----------------------------------------------------------------------------|
| **Conversion**          | `image.nii.gz`: Converted NIfTI file.                                       |
| **Metadata Extraction** | `image.json`: Extracted metadata in JSON format.                           |
| **Brain Segmentation**  | `image_bet_mask.nii.gz`: Brain mask generated by HD-BET.                   |
| **Registration**        | `image_registered_atlas.nii.gz`: Registered atlas.                         |
| **Radiomics Extraction**| `image_radiomics_features.csv`: Radiomics features by region (Atlas/ROIs).  |

---

## Example: CSV Output Structure

The output CSV files contain the following columns depending on the steps performed:

| **Column**         | **Description**                                              |
|-------------------|--------------------------------------------------------------|
| `Image`           | Name of the input image.                                     |
| `Source`          | Source of the extracted features (`brain_mask`, `atlas`, etc.). |
| `region_name`     | Name of the region or mask used.                             |
| **Features**      | `original_shape_VoxelVolume`, `original_glcm_Correlation`, etc. |

#### Example CSV:
```csv
Image,Source,region_name,atlas_region_label,original_firstorder_Mean,original_shape_VoxelVolume
image1,brain_mask,Brain Mask,,12.3,152000
image1,atlas,Frontal Lobe,1,15.7,134000
image1,input_roi,Custom_ROI_1,,20.4,50000
```

---

## Development

### For contributors and developers:
- **Main script**: `trex.py` (pipeline logic).
- **Modules**:
  - `dicom_nii_converter.py`: Handles DICOM to NIfTI conversion.
  - `metadata_extractor.py`: Extracts metadata from DICOM files.
  - `radiomics_extractor.py`: Extracts radiomics features.
  - `brain_extractor.py`: Generates brain masks.
  - `atlas_register.py`: Manages template/atlas registration.

---

## License

This project is licensed under the MIT License. See the `LICENSE` file for more details.

---

## Authors

- **Marc Saghiah**
- **Benjamin Lemasson**

For any questions or suggestions, feel free to contact us.

---